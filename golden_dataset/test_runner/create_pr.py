#!/usr/bin/env python3
"""
Create PR - Creates a git branch, applies diff, and opens a PR on GitHub.

This module handles:
1. Creating a new branch from base
2. Applying diff(s) from the evaluation
3. Committing the changes
4. Pushing to remote
5. Creating a PR via GitHub CLI
"""

import os
import re
import subprocess
import logging
from pathlib import Path

logging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')
logger = logging.getLogger(__name__)


def slugify(text):
    """Convert text to a slug for branch names."""
    text = text.lower()
    text = re.sub(r'[^a-z0-9]+', '-', text)
    text = text.strip('-')
    return text[:50]


def run_command(cmd, cwd=None, capture_output=True):
    """Run a shell command and return the result."""
    logger.debug(f"Running: {cmd}")
    result = subprocess.run(
        cmd,
        shell=True,
        cwd=cwd,
        capture_output=capture_output,
        text=True
    )
    if result.returncode != 0:
        logger.warning(f"Command failed: {cmd}")
        if result.stderr:
            logger.warning(f"stderr: {result.stderr}")
    return result


def apply_diff(diff_content, repo_path):
    """Apply a unified diff to the repository."""
    import tempfile
    
    with tempfile.NamedTemporaryFile(mode='w', suffix='.diff', delete=False) as f:
        f.write(diff_content)
        diff_file = f.name
    
    try:
        result = run_command(f"git apply {diff_file}", cwd=repo_path)
        if result.returncode != 0:
            logger.error(f"Failed to apply diff: {result.stderr}")
            return False
        return True
    finally:
        os.unlink(diff_file)


def create_branch(branch_name, base_branch, repo_path):
    """Create a new branch from base."""
    # Check if branch already exists and delete
    result = run_command(f"git branch -D {branch_name}", cwd=repo_path)
    
    # Create new branch
    result = run_command(
        f"git checkout -b {branch_name} origin/{base_branch}",
        cwd=repo_path
    )
    if result.returncode != 0:
        # Try without origin/ prefix
        result = run_command(
            f"git checkout -b {branch_name} {base_branch}",
            cwd=repo_path
        )
    return result.returncode == 0


def commit_changes(repo_path, commit_message):
    """Stage and commit all changes."""
    run_command("git add -A", cwd=repo_path)
    result = run_command(f'git commit -m "{commit_message}"', cwd=repo_path)
    return result.returncode == 0


def push_branch(branch_name, repo_path):
    """Push branch to remote."""
    result = run_command(
        f"git push -u origin {branch_name}",
        cwd=repo_path
    )
    return result.returncode == 0


def create_pull_request(evaluation, repo_url, base_branch):
    """Create a pull request via GitHub CLI."""
    pr_title = evaluation['pr_title']
    pr_description = evaluation['pr_description']
    evaluation_id = evaluation['id']
    categories = ', '.join(evaluation.get('categories', []))
    
    body = f"""## Test Evaluation #{evaluation_id}

{pr_description}

**Expected Review Categories:** {categories}

---
*This is a test PR generated by the golden dataset test runner.*
"""
    
    # Escape the body for shell
    body_escaped = body.replace('"', '\\"').replace('\n', '\\n')
    
    result = run_command(
        f'gh pr create --repo "{repo_url}" '
        f'--title "{pr_title}" '
        f'--body "{body_escaped}" '
        f'--base "{base_branch}"',
        capture_output=True
    )
    
    if result.returncode == 0:
        pr_url = result.stdout.strip()
        pr_number = pr_url.split('/')[-1]
        logger.info(f"Created PR #{pr_number}: {pr_url}")
        return pr_number, pr_url
    else:
        logger.error(f"Failed to create PR: {result.stderr}")
        return None, None


def create_pr_for_evaluation(evaluation, config):
    """
    Main function to create a PR for a single evaluation.
    
    Args:
        evaluation: Dict containing PR details and diffs
        config: Dict containing GitHub configuration
    
    Returns:
        Tuple of (pr_number, pr_url) or (None, None) on failure
    """
    github_config = config['github']
    runner_config = config['runner']
    
    owner = github_config['owner']
    repo = github_config['repo']
    base_branch = github_config['base_branch']
    repo_path = runner_config['repo_path']
    
    repo_url = f"{owner}/{repo}"
    branch_name = f"test-{evaluation['id']}-{slugify(evaluation['pr_title'])}"
    
    logger.info(f"Creating PR for evaluation #{evaluation['id']}: {evaluation['pr_title']}")
    
    # Step 1: Create branch
    logger.info(f"Creating branch: {branch_name}")
    if not create_branch(branch_name, base_branch, repo_path):
        logger.error("Failed to create branch")
        return None, None
    
    # Step 2: Apply diffs
    logger.info("Applying diffs...")
    for change in evaluation.get('changes', []):
        file_path = change.get('file', '')
        diff_content = change.get('diff', '')
        
        if diff_content:
            logger.info(f"  Applying diff to: {file_path}")
            if not apply_diff(diff_content, repo_path):
                logger.error(f"Failed to apply diff for {file_path}")
                # Rollback
                run_command(f"git checkout {base_branch}", cwd=repo_path)
                run_command(f"git branch -D {branch_name}", cwd=repo_path)
                return None, None
    
    # Step 3: Commit changes
    commit_message = f"Test: {evaluation['pr_title']}"
    logger.info(f"Committing: {commit_message}")
    if not commit_changes(repo_path, commit_message):
        logger.error("Failed to commit changes")
        run_command(f"git checkout {base_branch}", cwd=repo_path)
        run_command(f"git branch -D {branch_name}", cwd=repo_path)
        return None, None
    
    # Step 4: Push branch
    logger.info(f"Pushing branch: {branch_name}")
    if not push_branch(branch_name, repo_path):
        logger.error("Failed to push branch")
        run_command(f"git checkout {base_branch}", cwd=repo_path)
        run_command(f"git branch -D {branch_name}", cwd=repo_path)
        return None, None
    
    # Step 5: Create PR
    logger.info("Creating pull request...")
    pr_number, pr_url = create_pull_request(evaluation, repo_url, base_branch)
    
    # Return to base branch
    run_command(f"git checkout {base_branch}", cwd=repo_path)
    
    if pr_number:
        logger.info(f"Successfully created PR #{pr_number}")
        return pr_number, pr_url
    else:
        # Cleanup on failure
        run_command(f"git push origin --delete {branch_name}", cwd=repo_path)
        run_command(f"git branch -D {branch_name}", cwd=repo_path)
        return None, None


if __name__ == "__main__":
    # Example usage
    import yaml
    import json
    
    # Load config
    with open("config.yaml") as f:
        config = yaml.safe_load(f)
    
    # Load evaluation
    with open("../evaluations.json") as f:
        data = json.load(f)
    
    # Create PR for first evaluation
    evaluation = data['evaluations'][0]
    pr_num, pr_url = create_pr_for_evaluation(evaluation, config)
    print(f"Created PR: {pr_url}")
